<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem Absensi Digital SMP PURNAWARMAN — Super Final</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06); }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from {transform:rotate(0)} to {transform:rotate(360deg)} }
    .fade-in { animation: fadeIn .4s ease-in; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
    .tab-active { background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; }
    .status-connected { background: linear-gradient(90deg,#10b981,#059669); }
    .status-offline { background: linear-gradient(90deg,#f59e0b,#d97706); }
    .notification { position: fixed; top:1rem; right:1rem; z-index: 1000; transform: translateX(120%); transition: transform .25s; }
    .notification.show { transform: translateX(0);}
  </style>
</head>
<body class="h-full bg-gray-50">

<!-- ===== Login ===== -->
<div id="loginSection" class="min-h-full flex items-center justify-center gradient-bg px-4 sm:px-6 lg:px-8">
  <div class="max-w-md w-full space-y-6 py-10">
    <div class="text-center">
      <h1 class="text-4xl font-bold text-white mb-2">🏫 ABSENSI SMP PURNAWARMAN</h1>
      <p class="text-blue-100 text-sm">Sistem Absensi Digital Terintegrasi Google Sheets</p>
    </div>
    <div class="bg-white rounded-xl shadow-2xl p-8 card-shadow">
      <div class="mb-4 p-3 bg-blue-50 rounded-lg">
        <p class="text-sm text-blue-700 font-medium">🔑 Kredensial Login (Demo Mode):</p>
        <div class="mt-2 space-y-1 text-xs text-blue-600">
          <p><strong>Admin:</strong> admin / admin123</p>
          <p><strong>Guru:</strong> guru1 / guru123</p>
          <p><strong>Piket:</strong> piket / piket123</p>
          <p><strong>Guru 2:</strong> guru2 / guru456</p>
        </div>
        <div class="mt-2 p-2 bg-yellow-100 rounded text-xs text-yellow-700">
          💡 <strong>Tips:</strong> Buka Console (F12) untuk melihat debug info login
        </div>
      </div>
      <form id="loginForm" class="space-y-6">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <input id="username" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan username" value="admin">
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <div class="relative">
            <input id="password" type="password" required class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan password" value="admin123">
            <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 pr-3 flex items-center">
              <span class="text-gray-400 hover:text-gray-600">👁️</span>
            </button>
          </div>
        </div>
        <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
          ❌ Username atau password salah!
        </div>
        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center">
          🚪 Masuk
        </button>
      </form>
    </div>
  </div>
</div>

<!-- ===== Main App ===== -->
<div id="dashboardSection" class="hidden min-h-full bg-gray-50">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-4">
          <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
            <span class="text-white font-bold">📚</span>
          </div>
          <div>
            <h1 class="text-xl font-semibold text-gray-900">Sistem Absensi Sekolah SMP PURNAWARMAN</h1>
            <p id="currentTime" class="text-sm text-gray-500"></p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <div id="connectionStatus" class="px-3 py-1 rounded-full text-white text-xs font-medium status-offline">
            📱 Mode Demo - Offline
          </div>
          <div class="flex items-center space-x-2">
            <span id="userDisplay" class="text-sm text-gray-700">Admin User</span>
            <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm transition duration-200">
              🚪 Keluar
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex space-x-8">
        <button class="tab-btn tab-active px-4 py-3 text-sm font-medium rounded-t-lg transition duration-200" data-tab="dashboard">📊 Dashboard</button>
        <button class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 rounded-t-lg transition duration-200" data-tab="absensi">✅ Absensi</button>
        <button class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 rounded-t-lg transition duration-200" data-tab="laporan">📈 Laporan</button>
        <button class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 rounded-t-lg transition duration-200" data-tab="data">👥 Data</button>
        <button class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 rounded-t-lg transition duration-200" data-tab="setup">⚙️ Setup</button>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Dashboard Tab -->
    <div id="dashboardTab" class="tab-content fade-in">
      <!-- Statistics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
        <div class="bg-white rounded-xl p-6 card-shadow">
          <div class="flex items-center"><div class="p-2 bg-green-100 rounded-lg"><span class="text-green-600 text-xl">✅</span></div>
          <div class="ml-4"><p class="text-sm font-medium text-gray-600">Hadir</p><p class="text-2xl font-bold text-green-600" id="statHadir">0</p></div></div>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow">
          <div class="flex items-center"><div class="p-2 bg-yellow-100 rounded-lg"><span class="text-yellow-600 text-xl">🤒</span></div>
          <div class="ml-4"><p class="text-sm font-medium text-gray-600">Sakit</p><p class="text-2xl font-bold text-yellow-600" id="statSakit">0</p></div></div>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow">
          <div class="flex items-center"><div class="p-2 bg-blue-100 rounded-lg"><span class="text-blue-600 text-xl">📝</span></div>
          <div class="ml-4"><p class="text-sm font-medium text-gray-600">Izin</p><p class="text-2xl font-bold text-blue-600" id="statIzin">0</p></div></div>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow">
          <div class="flex items-center"><div class="p-2 bg-red-100 rounded-lg"><span class="text-red-600 text-xl">❌</span></div>
          <div class="ml-4"><p class="text-sm font-medium text-gray-600">Alpha</p><p class="text-2xl font-bold text-red-600" id="statAlpha">0</p></div></div>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow">
          <div class="flex items-center"><div class="p-2 bg-purple-100 rounded-lg"><span class="text-purple-600 text-xl">🏃</span></div>
          <div class="ml-4"><p class="text-sm font-medium text-gray-600">Bolos</p><p class="text-2xl font-bold text-purple-600" id="statBolos">0</p></div></div>
        </div>
      </div>

      <!-- Class Status -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="bg-white rounded-xl p-6 card-shadow">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Status Input Absensi Hari Ini</h3>
          <div class="grid grid-cols-3 gap-3" id="classStatusGrid">
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg"><span class="text-sm font-medium">Kelas 7A</span><span class="text-green-600 text-xs">✅ Sudah Input</span></div>
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg"><span class="text-sm font-medium">Kelas 7B</span><span class="text-green-600 text-xs">✅ Sudah Input</span></div>
            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg"><span class="text-sm font-medium">Kelas 7C</span><span class="text-red-600 text-xs">❌ Belum Input</span></div>
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg"><span class="text-sm font-medium">Kelas 8A</span><span class="text-green-600 text-xs">✅ Sudah Input</span></div>
            <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg"><span class="text-sm font-medium">Kelas 8B</span><span class="text-red-600 text-xs">❌ Belum Input</span></div>
            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg"><span class="text-sm font-medium">Kelas 9A</span><span class="text-green-600 text-xs">✅ Sudah Input</span></div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Statistik Guru Hari Ini</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center"><span class="text-sm text-gray-600">Total Guru Hadir</span><span class="font-semibold text-green-600" id="guruHadir">0</span></div>
            <div class="flex justify-between items-center"><span class="text-sm text-gray-600">Izin</span><span class="font-semibold text-blue-600" id="guruIzin">0</span></div>
            <div class="flex justify-between items-center"><span class="text-sm text-gray-600">Sakit</span><span class="font-semibold text-yellow-600" id="guruSakit">0</span></div>
            <div class="flex justify-between items-center"><span class="text-sm text-gray-600">Alpha</span><span class="font-semibold text-red-600" id="guruAlpha">0</span></div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="bg-white rounded-xl p-6 card-shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Aktivitas Terbaru</h3>
        <div class="space-y-3" id="recentActivity">
          <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
            <span class="text-green-600">✅</span>
            <div class="flex-1">
              <p class="text-sm font-medium">Sistem siap digunakan</p>
              <p class="text-xs text-gray-500">Baru saja</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Absensi Tab -->
    <div id="absensiTab" class="tab-content hidden">
      <div class="bg-white rounded-xl p-6 card-shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Form Input Absensi</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label><input type="date" id="attendanceDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Absensi</label><select id="attendanceType" class="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="Siswa">Siswa</option><option value="Guru">Guru</option></select></div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="attendanceClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg"><option value="7A">7A</option><option value="7B">7B</option><option value="7C">7C</option><option value="8A">8A</option><option value="8B">8B</option><option value="9A">9A</option></select></div>
          <div class="flex items-end"><button id="loadAttendanceBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">📋 Muat Data</button></div>
        </div>
        <div class="border-t pt-6" id="attendanceFormContainer">
          <div class="text-center py-8 text-gray-500">Pilih tanggal, jenis absensi, dan kelas, lalu klik "Muat Data".</div>
        </div>
      </div>
    </div>

    <!-- Laporan Tab -->
    <div id="laporanTab" class="tab-content hidden">
      <div class="bg-white rounded-xl p-6 card-shadow">
        <h3 class="text-lg font-semibold text-gray-900 mb-6">Generate Laporan Absensi</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label><input type="date" id="reportStartDate" class="w-full px-3 py-2 border rounded-lg"></div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Akhir</label><input type="date" id="reportEndDate" class="w-full px-3 py-2 border rounded-lg"></div>
          <div><label class="block text-sm font-medium text-gray-700 mb-2">Kelas</label><select id="reportClass" class="w-full px-3 py-2 border rounded-lg"><option value="Semua">Semua Kelas</option><option>7A</option><option>7B</option><option>7C</option><option>8A</option><option>8B</option><option>9A</option></select></div>
          <div class="flex items-end"><button id="generateReportBtn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">📈 Generate Laporan</button></div>
        </div>
        <div class="border-t pt-6" id="reportContainer">
          <div class="text-center py-8 text-gray-500">Pilih rentang tanggal dan kelas, lalu klik "Generate Laporan".</div>
        </div>
      </div>
    </div>

    <!-- Data Tab -->
    <div id="dataTab" class="tab-content hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-xl p-6 card-shadow">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">👨‍🎓 Data Siswa</h3>
          <div class="space-y-3 max-h-96 overflow-y-auto" id="studentsContainer"></div>
        </div>
        <div class="bg-white rounded-xl p-6 card-shadow">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">👨‍🏫 Data Guru</h3>
          <div class="space-y-3 max-h-96 overflow-y-auto" id="teachersContainer"></div>
        </div>
      </div>
    </div>

    <!-- Setup Tab -->
    <div id="setupTab" class="tab-content hidden">
      <div class="space-y-8">
        <!-- Koneksi -->
        <div class="bg-white rounded-xl p-6 card-shadow">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">🔗 Status Koneksi Google Sheets</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Sheet ID</label><input type="text" class="w-full px-3 py-2 border rounded-lg bg-gray-50" value="1WJB2DCVjj1UbZhJ61VGztRc2BB75vJWrwgEbmadybdI" readonly></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-2">Apps Script URL</label><input type="text" class="w-full px-3 py-2 border rounded-lg bg-gray-50 text-xs" value="https://script.google.com/macros/s/AKfycbwrSa3CFe8J478YZc20oVBTQDb3aVscuCSy6Lhc9rpCGDEVlKP9oJP8sXZFjqRxaSUkIw/exec" readonly></div>
          </div>
          <div class="flex flex-wrap gap-2 mt-4">
            <button id="testConnectionBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">🔄 Test Koneksi</button>
            <button id="syncDataBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">🔄 Sinkronisasi Data</button>
            <button id="syncPendingBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm">📤 Sync Pending Data</button>
            <button id="showBackupsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm">💾 Lihat Backup</button>
            <button id="showDebugBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">🔍 Debug Info</button>
          </div>
        </div>

        <!-- Debug Console -->
        <div class="bg-gray-900 rounded-xl p-6 card-shadow">
          <h3 class="text-lg font-semibold text-white mb-4">🔍 Debug Console</h3>
          <div id="debugConsole" class="bg-black rounded-lg p-4 h-64 overflow-y-auto text-green-400 font-mono text-sm"><div class="text-gray-500">Debug console ready...</div></div>
          <div class="flex space-x-2 mt-4">
            <button id="clearDebugBtn" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">🗑️ Clear</button>
            <button id="testSaveBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">🧪 Test Save</button>
          </div>
        </div>

        <!-- Panduan Setup -->
        <div class="bg-blue-50 rounded-xl p-6 card-shadow">
          <h3 class="text-lg font-semibold text-blue-900 mb-4">📋 Panduan Setup Google Sheets</h3>
          <div class="space-y-4 text-sm text-blue-800">
            <div>
              <p class="font-medium mb-2">1. Struktur Sheet yang diperlukan:</p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white p-3 rounded-lg"><p class="font-medium text-blue-900">Sheet "Users":</p><p class="text-xs font-mono">username | password | nama | role | hariPiket</p></div>
                <div class="bg-white p-3 rounded-lg"><p class="font-medium text-blue-900">Sheet "Siswa":</p><p class="text-xs font-mono">nama | nis | kelas</p></div>
                <div class="bg-white p-3 rounded-lg"><p class="font-medium text-blue-900">Sheet "JadwalGuru":</p><p class="text-xs font-mono">nama | nip | mapel | hari</p></div>
                <div class="bg-white p-3 rounded-lg"><p class="font-medium text-blue-900">Sheet "Absensi":</p><p class="text-xs font-mono">tanggal | kelas | jenisAbsensi | nama | identifier | status | timestamp | savedBy</p></div>
              </div>
            </div>
            <div>
              <p class="font-medium mb-2">2. Contoh Data Users:</p>
              <div class="bg-white p-3 rounded-lg font-mono text-xs">
                <div class="grid grid-cols-5 gap-2 font-bold border-b pb-1">
                  <span>username</span><span>password</span><span>nama</span><span>role</span><span>hariPiket</span>
                </div>
                <div class="grid grid-cols-5 gap-2 mt-1"><span>admin</span><span>admin123</span><span>Administrator</span><span>admin</span><span>-</span></div>
                <div class="grid grid-cols-5 gap-2"><span>guru1</span><span>guru123</span><span>Ahmad Fauzi</span><span>piket</span><span>Senin</span></div>
              </div>
            </div>
            <div>
              <p class="font-medium mb-2">3. Link Google Sheets:</p>
              <a href="https://docs.google.com/spreadsheets/d/1WJB2DCVjj1UbZhJ61VGztRc2BB75vJWrwgEbmadybdI/edit" target="_blank" class="text-blue-600 hover:text-blue-800 underline text-xs">📊 Buka Google Sheets</a>
            </div>
          </div>
        </div>

        <!-- Mode Info -->
        <div class="bg-orange-50 rounded-xl p-6 card-shadow">
          <h3 class="text-lg font-semibold text-orange-900 mb-4">📱 Mode Saat Ini: <span id="currentModeDisplay">Demo Offline</span></h3>
          <div class="text-sm text-orange-800 space-y-2">
            <p>✅ Sistem berjalan dalam mode demo dengan data sampel</p>
            <p>✅ Semua fitur dapat digunakan untuk testing</p>
            <p>⚠️ Data akan tersimpan ke Google Sheets saat koneksi berhasil</p>
            <p>🔄 Untuk mode online, pastikan Google Sheets dan Apps Script sudah dikonfigurasi benar</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-white border-t border-gray-200 mt-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <p class="text-center text-sm text-gray-500">Dikembangkan untuk SMP PURNAWARMAN | Google Sheets Integrated | Super Final 2025</p>
    </div>
  </footer>
</div>

<script>
// ============= KONFIGURASI =============
const SHEET_ID = "1WJB2DCVjj1UbZhJ61VGztRc2BB75vJWrwgEbmadybdI";
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrSa3CFe8J478YZc20oVBTQDb3aVscuCSy6Lhc9rpCGDEVlKP9oJP8sXZFjqRxaSUkIw/exec";

// Demo data
const DEMO_USERS = [
  { username:'admin', password:'admin123', nama:'Administrator', role:'admin', hariPiket:'' },
  { username:'guru1', password:'guru123', nama:'Ahmad Fauzi, S.Pd', role:'piket', hariPiket:'Senin' },
  { username:'guru2', password:'guru456', nama:'Siti Aminah, S.Pd', role:'guru', hariPiket:'Selasa' },
  { username:'piket', password:'piket123', nama:'Guru Piket', role:'piket', hariPiket:'Rabu' }
];
const DEMO_STUDENTS = [
  { nama:'Ahmad Rizki Pratama', nis:'001', kelas:'7A' },
  { nama:'Siti Nurhaliza', nis:'002', kelas:'7A' },
  { nama:'Budi Santoso', nis:'003', kelas:'7A' },
  { nama:'Dewi Sartika', nis:'004', kelas:'7A' },
  { nama:'Muhammad Iqbal', nis:'005', kelas:'7B' },
  { nama:'Fatimah Zahra', nis:'006', kelas:'7B' },
  { nama:'Andi Wijaya', nis:'007', kelas:'8A' },
  { nama:'Rina Melati', nis:'008', kelas:'8A' },
  { nama:'Doni Setiawan', nis:'009', kelas:'9A' },
  { nama:'Maya Sari', nis:'010', kelas:'9A' }
];
const DEMO_TEACHERS = [
  { nama:'Dra. Siti Aminah', nip:'196501011990032001', mapel:'Matematika', hari:'Senin' },
  { nama:'Ahmad Fauzi, S.Pd', nip:'197203151998021001', mapel:'IPA', hari:'Selasa' },
  { nama:'Rina Sari, S.S', nip:'198005102005012002', mapel:'Bahasa Indonesia', hari:'Rabu' },
  { nama:'Budi Hartono, S.Pd', nip:'197812252006041001', mapel:'IPS', hari:'Kamis' },
  { nama:'Dewi Lestari, S.Pd', nip:'198209102009012001', mapel:'Bahasa Inggris', hari:'Jumat' }
];

let isOnlineMode = false;
let currentUser = null;

// ===== Debug & Utils =====
function debugLog(message, type='info'){
  const consoleEl = document.getElementById('debugConsole');
  const timestamp = new Date().toLocaleTimeString('id-ID');
  const color = { info:'text-green-400', error:'text-red-400', warning:'text-yellow-400', success:'text-blue-400' }[type] || 'text-green-400';
  const logEntry = document.createElement('div');
  logEntry.className = color;
  logEntry.innerHTML = `[${timestamp}] ${message}`;
  consoleEl.appendChild(logEntry);
  consoleEl.scrollTop = consoleEl.scrollHeight;
}
function showNotification(message, type='info'){
  const n = document.createElement('div');
  n.className = `notification px-4 py-3 rounded-lg text-white text-sm font-medium shadow-lg ${ type==='success'?'bg-green-500': type==='error'?'bg-red-500': type==='warning'?'bg-yellow-500':'bg-blue-500' }`;
  n.textContent = message; document.body.appendChild(n);
  setTimeout(()=>n.classList.add('show'), 100);
  setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>n.remove(), 250); }, 2600);
}
function updateTime(){
  const now = new Date();
  const options = { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit', timeZone:'Asia/Jakarta' };
  document.getElementById('currentTime').textContent = now.toLocaleDateString('id-ID', options)+' WIB';
}
setInterval(updateTime, 1000);
document.getElementById('togglePassword').addEventListener('click', ()=>{
  const p = document.getElementById('password'); p.type = p.type==='password' ? 'text' : 'password';
});

// ===== Koneksi =====
async function testConnection(){
  try {
    const r = await fetch(APPS_SCRIPT_URL+`?action=test&ts=${Date.now()}`, { method:'GET', mode:'cors', cache:'no-cache' });
    debugLog('Test status: '+r.status);
    if(r.ok) {
      isOnlineMode = true;
      document.getElementById('connectionStatus').textContent = '✅ Mode Online - Google Sheets';
      document.getElementById('connectionStatus').className = 'px-3 py-1 rounded-full text-white text-xs font-medium status-connected';
      document.getElementById('currentModeDisplay').textContent = 'Online - Google Sheets';
      return true;
    }
  } catch(e) { debugLog('Test failed: '+e.message, 'error'); }
  isOnlineMode = false;
  document.getElementById('connectionStatus').textContent = '📱 Mode Demo - Offline';
  document.getElementById('connectionStatus').className = 'px-3 py-1 rounded-full text-white text-xs font-medium status-offline';
  document.getElementById('currentModeDisplay').textContent = 'Demo Offline';
  return false;
}

// ===== Auth =====
async function authenticateUser(username, password){
  const demoUser = DEMO_USERS.find(u=>u.username===username && u.password===password);
  if(demoUser) return { success:true, user: demoUser };
  if(isOnlineMode) {
    try {
      const url = APPS_SCRIPT_URL+`?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
      const r = await fetch(url); const j = await r.json(); return j;
    } catch(e) { debugLog('Online auth failed: '+e.message,'error'); }
  }
  return { success:false, error:'Invalid credentials' };
}

// ===== Data Load (offline demo; bisa diganti online getData) =====
async function loadData(){
  let students = DEMO_STUDENTS;
  let teachers = DEMO_TEACHERS;

  if(isOnlineMode) {
    try {
      const rs = await fetch(APPS_SCRIPT_URL+`?action=getData&sheet=Siswa`); const sj = await rs.json(); if(sj.success && sj.data && sj.data.length) students = sj.data;
      const rt = await fetch(APPS_SCRIPT_URL+`?action=getData&sheet=JadwalGuru`); const tj = await rt.json(); if(tj.success && tj.data && tj.data.length) teachers = tj.data;
    } catch(e) { debugLog('Load online data failed: '+e.message, 'error'); }
  }

  const sc = document.getElementById('studentsContainer'); sc.innerHTML='';
  students.forEach(student=>{
    const div = document.createElement('div'); div.className='flex items-center justify-between p-3 bg-gray-50 rounded-lg';
    div.innerHTML = `<div><p class='font-medium text-sm'>${student.nama}</p><p class='text-xs text-gray-500'>NIS: ${student.nis||'-'}</p></div><span class='bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs'>${student.kelas||'-'}</span>`;
    sc.appendChild(div);
  });

  const tc = document.getElementById('teachersContainer'); tc.innerHTML='';
  teachers.forEach(teacher=>{
    const div = document.createElement('div'); div.className='flex items-center justify-between p-3 bg-gray-50 rounded-lg';
    div.innerHTML = `<div><p class='font-medium text-sm'>${teacher.nama}</p><p class='text-xs text-gray-500'>NIP: ${teacher.nip||'-'} | ${teacher.mapel||'-'}</p></div><span class='bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs'>${teacher.hari||'-'}</span>`;
    tc.appendChild(div);
  });

  window.currentStudents = students;
  window.currentTeachers = teachers;
  debugLog(`✅ Data loaded: ${students.length} siswa, ${teachers.length} guru`, 'success');
}

// ===== Absensi =====
function loadAttendanceForm(){
  const selectedClass = document.getElementById('attendanceClass').value;
  const attendanceType = document.getElementById('attendanceType').value;
  const container = document.getElementById('attendanceFormContainer');

  let data = [];
  if(attendanceType==='Siswa') data = (window.currentStudents || DEMO_STUDENTS).filter(s=>s.kelas===selectedClass);
  else data = window.currentTeachers || DEMO_TEACHERS;

  container.innerHTML = `
    <div class='flex justify-between items-center mb-4'>
      <h4 class='font-medium text-gray-900'>Daftar ${attendanceType} ${attendanceType==='Siswa' ? 'Kelas '+selectedClass : ''}</h4>
      <div class='space-x-2'>
        <button id='setAllPresentBtn' class='bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm'>✅ Semua Hadir</button>
        <button id='saveAttendanceBtn' class='bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm'>💾 Simpan Absensi</button>
      </div>
    </div>
    <div class='grid grid-cols-1 md:grid-cols-2 gap-4' id='attendanceList'>
      ${data.map(item=>`
        <div class='flex items-center justify-between p-3 bg-gray-50 rounded-lg'>
          <span class='text-sm'>${item.nama} (${attendanceType==='Siswa' ? (item.nis||'-') : (item.nip||'-')})</span>
          <select class='px-2 py-1 border border-gray-300 rounded text-xs attendance-select' data-name='${item.nama}' data-id='${attendanceType==='Siswa' ? (item.nis||'') : (item.nip||'')}' data-kelas='${item.kelas||''}'>
            <option value='Hadir'>Hadir</option>
            <option value='Sakit'>Sakit</option>
            <option value='Izin'>Izin</option>
            <option value='Alpha'>Alpha</option>
            ${attendanceType==='Siswa' ? '<option value="Bolos">Bolos</option>' : ''}
          </select>
        </div>
      `).join('')}
    </div>
    <div class='mt-4 p-3 bg-blue-50 rounded-lg'><p class='text-sm text-blue-700'>👨‍🏫 Petugas: ${currentUser ? currentUser.nama : 'Administrator'}</p></div>`;

  document.getElementById('setAllPresentBtn').addEventListener('click', ()=>{
    document.querySelectorAll('.attendance-select').forEach(s=>s.value='Hadir');
    showNotification('✅ Semua status diset ke Hadir', 'success');
  });
  document.getElementById('saveAttendanceBtn').addEventListener('click', onSaveAttendance);
}

async function saveAttendanceToSheet(attendanceData){
  debugLog(`💾 Mengirim ${attendanceData.length} baris ke Google Sheets...`,'info');
  try {
    const response = await fetch(APPS_SCRIPT_URL, {
      method:'POST', mode:'cors', cache:'no-cache',
      headers:{'Content-Type':'application/json','Accept':'application/json, text/plain, */*'},
      body: JSON.stringify({ action:'saveAttendance', sheetId:SHEET_ID, data: attendanceData })
    });
    const text = await response.text();
    debugLog(`📥 Raw response: ${text}`,'info');
    let ok=false; try{ ok = JSON.parse(text).success===true; }catch{ ok = /success|ok|saved|appended/i.test(text); }
    if(ok) return { success:true };
    throw new Error('Response tidak valid: '+text.substring(0,120));
  } catch(err) {
    debugLog('❌ Save error: '+err.message,'error');
    return { success:false, error: err.message };
  }
}

async function onSaveAttendance(){
  const selectedDate = document.getElementById('attendanceDate').value;
  const attendanceType = document.getElementById('attendanceType').value;
  const selectedClass = document.getElementById('attendanceClass').value;
  if(!selectedDate) return showNotification('❌ Pilih tanggal terlebih dahulu!','error');
  const selects = document.querySelectorAll('.attendance-select');
  const rows = Array.from(selects).map(select=>({
    tanggal: selectedDate,
    kelas: attendanceType==='Siswa' ? (select.dataset.kelas || selectedClass) : '',
    jenisAbsensi: attendanceType,
    nama: select.dataset.name,
    identifier: select.dataset.id,
    status: select.value,
    timestamp: new Date().toISOString(),
    savedBy: currentUser ? currentUser.nama : 'Administrator'
  }));

  const btn = document.getElementById('saveAttendanceBtn');
  btn.disabled = true; btn.textContent = '💾 Menyimpan...';

  const online = await testConnection();
  const result = online ? await saveAttendanceToSheet(rows) : { success:false };

  if(result.success){
    showNotification(`✅ BERHASIL! Absensi ${attendanceType} tersimpan ke Google Sheets! (${rows.length} data)`, 'success');
    localStorage.setItem(`backup_${Date.now()}`, JSON.stringify({ ts:new Date().toISOString(), data: rows, status:'synced' }));
  } else {
    const k = `pending_${Date.now()}`;
    localStorage.setItem(k, JSON.stringify({ ts:new Date().toISOString(), data: rows, status:'pending' }));
    showNotification('⚠️ Koneksi bermasalah. Data disimpan lokal & akan otomatis sync nanti.', 'warning');
  }

  btn.disabled = false; btn.textContent = '💾 Simpan Absensi';
  updateStatistics();
  addRecentActivity('Data absensi tersimpan.', result.success ? '✅' : '⚠️');
}

// ===== Backups Viewer & Sync =====
function showBackups(){
  const keys = Object.keys(localStorage).filter(k=>k.startsWith('backup_')||k.startsWith('pending_')).sort();
  const lines = keys.map(k=>{ const v = JSON.parse(localStorage.getItem(k)||'null'); const n=(v&&v.data)?v.data.length:0; return `• ${k} — ${n} baris — ${v&&v.status}`; });
  alert(lines.length? ['Daftar backup/pending:', ...lines].join('\n') : 'Tidak ada backup/pending');
}
async function syncPending(){
  const keys = Object.keys(localStorage).filter(k=>k.startsWith('pending_'));
  if(!keys.length) return showNotification('Tidak ada data pending','info');
  const online = await testConnection(); if(!online) return showNotification('Masih offline','warning');
  let sent=0, fail=0;
  for(const k of keys){
    const obj = JSON.parse(localStorage.getItem(k)||'{}'); const rows = obj.data||[];
    if(!rows.length) continue;
    const ok = await saveAttendanceToSheet(rows);
    if(ok.success){ localStorage.removeItem(k); sent += rows.length; localStorage.setItem(`backup_${Date.now()}`, JSON.stringify({ts:new Date().toISOString(), data: rows, status:'synced'})); }
    else fail += rows.length;
  }
  showNotification(`Sync selesai. Terkirim: ${sent} • Gagal: ${fail}`, fail?'warning':'success');
}

// ===== Laporan (dummy generator) =====
function generateReport(){
  const s = document.getElementById('reportStartDate').value;
  const e = document.getElementById('reportEndDate').value;
  const c = document.getElementById('reportClass').value;
  if(!s||!e) return showNotification('❌ Pilih tanggal mulai & akhir','error');
  const data = (window.currentStudents||DEMO_STUDENTS).filter(x=>c==='Semua'||x.kelas===c).map(st=>({
    nama: st.nama, kelas: st.kelas, hadir: Math.floor(Math.random()*5)+15, izin: Math.floor(Math.random()*3), sakit: Math.floor(Math.random()*2), alpha: Math.floor(Math.random()*2), total: 20
  }));
  const html = [`<div class='mb-3'><h4 class='font-medium'>Laporan Absensi</h4><p class='text-sm text-gray-600'>Periode: ${s} — ${e} | Kelas: ${c}</p></div>`,
  `<div class='overflow-x-auto'><table class='min-w-full'><thead><tr class='border-b'>`+
  `<th class='text-left py-2 text-xs'>Nama</th><th class='text-left py-2 text-xs'>Kelas</th><th class='text-left py-2 text-xs'>Hadir</th><th class='text-left py-2 text-xs'>Izin</th><th class='text-left py-2 text-xs'>Sakit</th><th class='text-left py-2 text-xs'>Alpha</th><th class='text-left py-2 text-xs'>%</th>`+
  `</tr></thead><tbody>`+
  data.map(d=>{ const p=Math.round((d.hadir/d.total)*100); return `<tr class='border-b'><td class='py-2 text-sm'>${d.nama}</td><td class='py-2 text-sm'>${d.kelas}</td><td class='py-2 text-sm'>${d.hadir}</td><td class='py-2 text-sm'>${d.izin}</td><td class='py-2 text-sm'>${d.sakit}</td><td class='py-2 text-sm'>${d.alpha}</td><td class='py-2 text-sm'>${p}%</td></tr>`; }).join('')+
  `</tbody></table></div>`].join('');
  document.getElementById('reportContainer').innerHTML = html;
}

// ===== Dashboard helpers =====
function updateStatistics(){
  const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  document.getElementById('statHadir').textContent = rand(820, 870);
  document.getElementById('statSakit').textContent = rand(10, 25);
  document.getElementById('statIzin').textContent  = rand(8, 20);
  document.getElementById('statAlpha').textContent = rand(2, 12);
  document.getElementById('statBolos').textContent = rand(1, 5);
  document.getElementById('guruHadir').textContent = rand(24, 32);
  document.getElementById('guruIzin').textContent  = rand(1, 4);
  document.getElementById('guruSakit').textContent = rand(0, 2);
  document.getElementById('guruAlpha').textContent = rand(0, 1);
}
function addRecentActivity(text, icon='📝'){
  const c = document.getElementById('recentActivity');
  const d = document.createElement('div');
  d.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg';
  d.innerHTML = `<span>${icon}</span><div class='flex-1'><p class='text-sm font-medium'>${text}</p><p class='text-xs text-gray-500'>${new Date().toLocaleTimeString('id-ID')} WIB</p></div>`;
  c.prepend(d);
}

// ===== Event Bindings =====
document.getElementById('testConnectionBtn').addEventListener('click', testConnection);
document.getElementById('syncDataBtn').addEventListener('click', syncPending);
document.getElementById('syncPendingBtn').addEventListener('click', syncPending);
document.getElementById('showBackupsBtn').addEventListener('click', showBackups);
document.getElementById('showDebugBtn').addEventListener('click', ()=>showNotification('Buka console (F12) untuk detail log','info'));
document.getElementById('clearDebugBtn').addEventListener('click', ()=>document.getElementById('debugConsole').innerHTML='');
document.getElementById('generateReportBtn').addEventListener('click', generateReport);

document.getElementById('logoutBtn').addEventListener('click',()=>{
  document.getElementById('dashboardSection').classList.add('hidden');
  document.getElementById('loginSection').classList.remove('hidden');
});

Array.from(document.getElementsByClassName('tab-btn')).forEach(btn=>btn.addEventListener('click',()=>{
  Array.from(document.getElementsByClassName('tab-btn')).forEach(b=>b.classList.remove('tab-active'));
  btn.classList.add('tab-active');
  const tab = btn.dataset.tab;
  Array.from(document.getElementsByClassName('tab-content')).forEach(c=>c.classList.add('hidden'));
  document.getElementById(tab+'Tab').classList.remove('hidden');
}));

document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  await testConnection();
  const res = await authenticateUser(u,p);
  if(res.success){
    currentUser = res.user;
    document.getElementById('loginSection').classList.add('hidden');
    document.getElementById('dashboardSection').classList.remove('hidden');
    document.getElementById('userDisplay').textContent = currentUser.nama;
    loadData(); updateStatistics(); updateTime();
  } else {
    document.getElementById('loginError').classList.remove('hidden');
  }
});

document.getElementById('loadAttendanceBtn').addEventListener('click', loadAttendanceForm);

// Autosync saat load & ketika kembali online
window.addEventListener('load', ()=>{ testConnection(); setTimeout(syncPending, 1500); });
window.addEventListener('online', ()=>{ debugLog('Back online → autosync'); syncPending(); });
</script>
</body>
</html>
