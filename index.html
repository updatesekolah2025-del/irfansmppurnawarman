<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMP Purnawarman â€” Sistem Absensi Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --primary:#0b3a82; --accent:#d4af37; --muted:#f6f7fb; }
    body{background:linear-gradient(180deg,#0b3a82 0%,#174b9c 35%,#fafafa 35%,#fafafa 100%);}
    .brand-header{background:linear-gradient(90deg,var(--primary),#12356f);color:white;position:relative;padding:2rem 1rem 3rem;box-shadow:0 2px 12px rgba(0,0,0,.25)}
    .brand-header .gold-bar{position:absolute;left:0;right:0;bottom:0;height:6px;background:linear-gradient(90deg,#b0891a,var(--accent),#ffe08a)}
    .card{background:white;border-radius:1rem;box-shadow:0 8px 24px rgba(10,38,71,.08)}
    .pill{border-radius:999px}
    .spin{animation:spin 1s linear infinite}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .tab-active{color:var(--primary);border-bottom:2px solid var(--primary);font-weight:700;background:#f3f7ff}
    .btn{border-radius:.75rem;padding:.5rem .9rem}
    .btn:disabled{opacity:0.6;cursor:not-allowed;}
    .btn-primary{background:var(--primary);color:white}
    .btn-accent{background:var(--accent);color:#2a2000}
  </style>
</head>
<body class="min-h-screen">

  <header class="brand-header">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-white/10 flex items-center justify-center ring-2 ring-white/30">ğŸ«</div>
        <div>
          <h1 class="text-xl font-bold tracking-wide">SMP Purnawarman</h1>
          <p class="text-sm text-white/80">Sistem Absensi Siswa & Guru</p>
        </div>
      </div>
      <div id="headerUser" class="hidden text-right">
        <p class="text-xs text-white/70">Masuk sebagai</p>
        <p id="loggedInUser" class="font-semibold"></p>
      </div>
    </div>
    <div class="gold-bar"></div>
  </header>

  <!-- LOGIN -->
  <section id="loginScreen" class="max-w-md mx-auto -mt-12 p-6 card">
    <h2 class="text-lg font-bold text-center text-[var(--primary)] mb-2">Masuk</h2>
    <p class="text-center text-gray-600 mb-4">Gunakan akun dari Sheet tab <b>Users</b></p>
    <form id="loginForm" class="space-y-3">
      <input id="username" type="text" placeholder="Username" class="w-full px-4 py-2 border rounded-lg" required>
      <input id="password" type="password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg" required>
      <button type="submit" class="btn btn-primary w-full">Masuk</button>
    </form>
    <div id="loginError" class="hidden mt-3 text-sm p-3 bg-red-50 text-red-700 rounded-lg"></div>
    <div class="mt-4 text-xs text-gray-500">Sheet ID: <code id="sheetShown"></code></div>
  </section>

  <!-- MAIN APP -->
  <main id="mainApp" class="hidden max-w-7xl mx-auto p-4">
    <div class="flex items-center justify-between text-sm mb-4">
      <div id="connectionStatus" class="pill bg-yellow-100 text-yellow-900 px-3 py-1 flex items-center gap-2">
        <span class="w-3 h-3 border-2 border-yellow-700 border-t-transparent rounded-full spin"></span> Menghubungkan...
      </div>
      <button onclick="logout()" class="btn btn-accent">Keluar</button>
    </div>

    <div class="card overflow-hidden">
      <div class="flex border-b text-sm font-medium bg-white/60">
        <button id="tab-dashboard" class="flex-1 py-3 tab-active" onclick="showTab('dashboard')">ğŸ“Š Dashboard</button>
        <button id="tab-absensi"   class="flex-1 py-3" onclick="showTab('absensi')">âœ… Absensi</button>
        <button id="tab-data"      class="flex-1 py-3" onclick="showTab('data')">ğŸ‘¥ Data</button>
      </div>

      <!-- DASHBOARD -->
      <section id="content-dashboard" class="p-6">
        <h3 class="font-bold mb-4 text-[var(--primary)]">ğŸ“ˆ Statistik Hari Ini</h3>
        <div id="statArea" class="grid md:grid-cols-2 gap-6">
          <div class="card p-5 ring-1 ring-black/5">
            <h4 class="font-bold mb-2">Kehadiran Siswa</h4>
            <canvas id="chartSiswa" height="160"></canvas>
          </div>
          <div class="card p-5 ring-1 ring-black/5">
            <h4 class="font-bold mb-2">Kehadiran Guru</h4>
            <canvas id="chartGuru" height="160"></canvas>
          </div>
        </div>
      </section>

      <!-- ABSENSI -->
      <section id="content-absensi" class="hidden p-6">
        <h3 class="font-bold mb-4 text-[var(--primary)]">Input Absensi</h3>
        <div class="grid md:grid-cols-3 gap-3 mb-3">
          <input id="tanggal" type="date" class="px-3 py-2 border rounded-lg">
          <select id="jenisAbsensi" class="px-3 py-2 border rounded-lg" onchange="toggleKelasField()">
            <option value="">Pilih Jenis</option>
            <option value="siswa">Siswa</option>
            <option value="guru">Guru</option>
          </select>
          <select id="kelas" class="px-3 py-2 border rounded-lg">
            <option value="">Pilih Kelas</option>
          </select>
        </div>
        <div class="flex gap-2 mb-4">
          <button class="btn btn-primary" onclick="loadAbsensiData()">ğŸ“‹ Muat Data</button>
          <button id="btnSemuaHadir" class="btn btn-accent hidden" onclick="markAllHadir()">âœ… Semua Hadir</button>
          <button id="saveAbsensiBtn" class="btn bg-indigo-600 text-white hidden" onclick="saveAbsensi()">ğŸ’¾ Simpan</button>
        </div>
        <div id="absensiList" class="hidden card p-4 ring-1 ring-black/5"></div>
      </section>

      <!-- DATA -->
      <section id="content-data" class="hidden p-6">
        <h3 class="font-bold mb-3 text-[var(--primary)]">ğŸ‘¥ Data Siswa</h3>
        <div id="dataSiswa" class="text-sm text-gray-700">Memuat...</div>
      </section>
    </div>
  </main>

  <!-- TOAST -->
  <div id="notification" class="fixed top-5 right-5 z-50 hidden">
    <div id="notificationContent" class="px-4 py-2 rounded-lg text-white bg-emerald-600 shadow-lg">
      <span id="notificationText"></span>
    </div>
  </div>

  <script>
    // Konfigurasi
    const SHEET_ID  = "1WJB2DCVjj1UbZhJ61VGztRc2BB75vJWrwgEbmadybdI";
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYUocNKA0BmEPLkkC0ZEjX516JkoUXuSpif2uoZ7y2LlrS3quNwXCTCJKfUAsIIbAwmg/exec";
    document.getElementById("sheetShown").textContent = SHEET_ID;

    let currentUser = null;
    let allStudents = [], allTeachers = [], currentAbsensiData = [];

    // ===================== Toast =====================
    function toast(msg, type="success"){
      const box=document.getElementById("notification");
      const cont=document.getElementById("notificationContent");
      document.getElementById("notificationText").textContent=msg;
      cont.className="px-4 py-2 rounded-lg text-white shadow-lg " + (type==="error"?"bg-red-600":type==="loading"?"bg-yellow-600":"bg-emerald-600");
      box.classList.remove("hidden");
      setTimeout(()=>box.classList.add("hidden"),4000);
    }

    // ===================== API =====================
    async function apiGet(params={}) {
      const url=new URL(SCRIPT_URL);
      Object.entries(params).forEach(([k,v])=>url.searchParams.append(k,v));
      try{const res=await fetch(url);return await res.json();}catch(e){return{success:false,error:e.message};}
    }
    async function apiPost(action,payload){
      try{
        const res=await fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action,...payload})});
        const text=await res.text();return JSON.parse(text);
      }catch(err){return{success:false,error:"Koneksi gagal: "+err.message}}
    }

    // ===================== Login =====================
    document.getElementById("loginForm").addEventListener("submit", async(e)=>{
      e.preventDefault();
      const u=document.getElementById("username").value.trim();
      const p=document.getElementById("password").value.trim();
      const r=await apiGet({action:"getUsers",sheetId:SHEET_ID});
      if(r.success){
        const user=r.data.find(x=>x.username===u && x.password===p);
        if(!user)return showLoginError("Username atau password salah");
        currentUser=user;
        localStorage.setItem("user",JSON.stringify(user));
        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("mainApp").classList.remove("hidden");
        document.getElementById("loggedInUser").textContent=user.nama;
        testGoogleSheetsConnection();
        loadDashboard();
      } else toast("Gagal ambil data pengguna","error");
    });

    function showLoginError(msg){const el=document.getElementById("loginError");el.textContent=msg;el.classList.remove("hidden");}
    function logout(){localStorage.clear();location.reload();}

    // ===================== Connection Test =====================
    async function testGoogleSheetsConnection(){
      const el=document.getElementById("connectionStatus");
      try{
        const res=await fetch(`${SCRIPT_URL}?action=test&sheetId=${SHEET_ID}`);
        const d=await res.json();
        if(d.success){el.className="pill bg-emerald-100 text-emerald-900 px-3 py-1";el.innerHTML="âœ… Terhubung";}
        else throw new Error(d.error||"Tidak valid");
      }catch(e){el.className="pill bg-red-100 text-red-900 px-3 py-1";el.innerHTML="âŒ Gagal: "+e.message;}
    }

    // ===================== Absensi =====================
    function toggleKelasField(){document.getElementById("kelas").disabled=document.getElementById("jenisAbsensi").value!=="siswa";}
    async function loadAbsensiData(){
      const jenis=document.getElementById("jenisAbsensi").value,kelas=document.getElementById("kelas").value,tanggal=document.getElementById("tanggal").value;
      if(!jenis||!tanggal||(jenis==="siswa"&&!kelas))return toast("Lengkapi pilihan","error");
      const list=jenis==="siswa"?await apiGet({action:"getSiswa",sheetId:SHEET_ID}):await apiGet({action:"getJadwalGuru",sheetId:SHEET_ID});
      const data=list.success?list.data:[];
      currentAbsensiData=data.map(x=>({tanggal,kelas,jenisAbsensi:jenis,nama:x.nama,identifier:x.nis||x.nip||x.nama,status:"Hadir",savedBy:currentUser.username}));
      const cont=document.getElementById("absensiList");
      cont.classList.remove("hidden");
      cont.innerHTML=currentAbsensiData.map((r,i)=>`
        <div class="flex justify-between items-center border rounded p-2">
          <div><div class="font-medium">${r.nama}</div><div class="text-xs text-gray-500">${r.identifier}</div></div>
          <select data-i="${i}" class="border rounded px-2 py-1" onchange="changeStatus(event)">
            ${["Hadir","Sakit","Izin","Alpha","Bolos"].map(s=>`<option ${s===r.status?"selected":""}>${s}</option>`).join("")}
          </select>
        </div>`).join("");
      document.getElementById("btnSemuaHadir").classList.remove("hidden");
      document.getElementById("saveAbsensiBtn").classList.remove("hidden");
    }

    function changeStatus(e){currentAbsensiData[e.target.dataset.i].status=e.target.value;}
    function markAllHadir(){currentAbsensiData.forEach(r=>r.status="Hadir");document.querySelectorAll("#absensiList select").forEach(s=>s.value="Hadir");toast("Semua hadir ditandai","success");}

    async function saveAbsensi(){
      if(currentAbsensiData.length===0)return toast("Tidak ada data","error");
      const btn=document.getElementById("saveAbsensiBtn");btn.disabled=true;
      btn.innerHTML='<span class="w-4 h-4 border-2 border-white border-t-transparent rounded-full spin inline-block"></span> Menyimpan...';
      toast("ğŸ“¤ Mengirim ke Google Sheet...","loading");
      const r=await apiPost("saveAbsensi",{sheetId:SHEET_ID,items:currentAbsensiData});
      if(r.success){toast("âœ… Tersimpan!","success");setTimeout(()=>loadDashboard(),5000);}else toast("âŒ Gagal: "+r.error,"error");
      btn.disabled=false;btn.innerHTML="ğŸ’¾ Simpan";
    }

    // ===================== Dashboard =====================
    async function loadDashboard(){
      const r=await apiGet({action:"getAbsensiRange",sheetId:SHEET_ID});
      const data=r.success?r.data:[];
      const count=(j,s)=>data.filter(x=>x.jenisAbsensi===j&&x.status===s).length;
      const sData=[count("siswa","Hadir"),count("siswa","Sakit"),count("siswa","Izin"),count("siswa","Alpha"),count("siswa","Bolos")];
      const gData=[count("guru","Hadir"),count("guru","Sakit"),count("guru","Izin"),count("guru","Alpha")];
      new Chart(document.getElementById("chartSiswa"),{type:"bar",data:{labels:["Hadir","Sakit","Izin","Alpha","Bolos"],datasets:[{label:"Siswa",data:sData,backgroundColor:"#0b3a82"}]}});
      new Chart(document.getElementById("chartGuru"),{type:"pie",data:{labels:["Hadir","Sakit","Izin","Alpha"],datasets:[{label:"Guru",data:gData,backgroundColor:["#2ecc71","#f1c40f","#3498db","#e74c3c"]}]}})
    }

    function showTab(name){
      document.querySelectorAll('[id^=content-]').forEach(x=>x.classList.add("hidden"));
      document.querySelectorAll('[id^=tab-]').forEach(x=>x.classList.remove("tab-active"));
      document.getElementById("content-"+name).classList.remove("hidden");
      document.getElementById("tab-"+name).classList.add("tab-active");
    }
  </script>
</body>
</html>
